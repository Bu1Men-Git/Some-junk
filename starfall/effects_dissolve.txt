--@name effects dissolve
--@author Kilo
--@shared




tick = game.getTickInterval()
interval = 8
mass = 50000



local O = owner()
local C = chip()

local WorldEntity = game.getWorld()



local crowbarAttack = true



function effectPlay(pos, norm)
    local hitEffect = effect.create()
    local eyeTrace = O:getEyeTrace() 
    hitEffect:setOrigin(pos)
    hitEffect:setNormal(norm)
    hitEffect:play("HL1GaussWallImpact2")
end

if SERVER then
    
  --  C:setSolid(false) --no perms?
    
    hook.add("PlayerSay", "onChat", function(ply, txt)
        if ply==O && txt:sub(1,1) == "#" then
            net.start("playTTS")
            net.writeString("http://translate.google.com/translate_tts?ie=utf-8&q=" .. txt:sub(2) .. "&tl=en-gb&client=tw-ob")
            net.send()

            return ""
        end
    end)

    hook.add("KeyPress", "onPress", function(ply, key)
        if ply==O then
            if owner():isAlive() then 
            if O:getActiveWeapon():getClass() == "weapon_crowbar" then
                if key == 2048 then --change attack type RMB
                    crowbarAttack = !crowbarAttack
                    print(crowbarAttack)
                elseif key == 1 and crowbarAttack and prop.canSpawn() then --attack LMB
                    local eyeTrace = O:getEyeTrace()
                    
                    effectPlay(eyeTrace.HitPos, eyeTrace.HitNormal)
                    net.start("kEffectPlay")
                    net.writeVector(eyeTrace.HitPos)
                    net.writeVector(eyeTrace.HitNormal)
                    net.send(O)
                    
        local forw = O:getEyeAngles():getForward()*25
                    local projectile = prop.create(O:getShootPos() + forw + O:getVelocity() * tick * interval, Angle(), "models/led2.mdl", false)
                    timer.create("moveTrail"..timer.curtime(), 0.01, 10, function()
                        projectile:applyForceCenter(forw * 100 * mass)
                    end)
                    projectile:enableGravity(0)
                    projectile:setMass(mass)
                    physEnt = projectile:getPhysicsObject()
                    physEnt:addGameFlags(FVPHYSICS.DMG_DISSOLVE)
                    //projectile:setColor(Color(0, 0, 0, 0))
                    projectile:setTrails(300, 0, 2, "trails/laser", Color(255, 255, 0)) --eyeTrace.HitPos:getDistance(eyeTrace.StartPos)
                    
                    timer.create("removeTrail"..timer.curtime(), 1.5, 1, function()
                        projectile:remove()
                    end)
                end
            end
        end
    end
end)
else
   
            
            net.receive("kEffectPlay", function()
                local hitPos = net.readVector()
                local hitNorm = net.readVector()
                effectPlay(hitPos, hitNorm)
            end)
            
        end
    
